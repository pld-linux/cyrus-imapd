--- cyrus-imapd-2.4.4/com_err/et/Makefile.in	2010-11-30 07:53:22.181949458 +0200
+++ cyrus-imapd-2.4.4-shared-patch//com_err/et/Makefile.in	2010-11-29 09:02:12.537952808 +0200
@@ -44,11 +44,12 @@
 # $Id$
 
 srcdir = @srcdir@
+top_builddir = @top_builddir@
 VPATH = @srcdir@
 
 CC = @CC@
 INSTALL = @INSTALL@
-RANLIB = @RANLIB@
+LIBTOOL = @LIBTOOL@
 ARCHIVE = ar cr
 
 AWK = @AWK@
@@ -71,8 +72,8 @@
 
 install:
 
-.c.lo:
-	$(CC) -c $(CPPFLAGS) $(DEFS) -I$(srcdir) -I$(srcdir)/../../lib -I. -I../.. $(CFLAGS) $<
+%.lo: %.c
+	$(LIBTOOL) --mode=compile --tag=CC $(CC) -c $(CPPFLAGS) $(DEFS) -I$(srcdir) -I$(srcdir)/../../lib -I. -I../.. $(CFLAGS) $<
 
 # solaris make loses on com_err.c but not on init_et.c, but this helps
 com_err.lo: com_err.c
@@ -92,14 +93,9 @@
 	$(CP) $(srcdir)/et_h.lawk et_h.lawk
 
 clean:
-	rm -f compile_et compile_et.lo error_table.lo 
-	rm -f libcom_err.la
-	rm -f $(LIBOBJS)
+	rm -rf .libs *.la *.lo *.o compile_et $(LIBOBJS)
 
 distclean: clean
-	rm -f compile_et compile_et.lo error_table.lo 
-	rm -f libcom_err.la
-	rm -f $(LIBOBJS)
 	rm Makefile
 
 depend: compile_et 
@@ -120,20 +116,14 @@
 ## install_library_target(com_err,$(LIBOBJS),$(LINTFILES),)
 
 libcom_err.la: $(LIBOBJS)
-	rm -f libcom_err.la
-	$(ARCHIVE) $@ $(LIBOBJS)
-	$(RANLIB) $@
+	$(LIBTOOL) --mode=link --tag=CC $(CC) -o $@ $(LIBOBJS)
 
 #install::
-#	$(INSTALLLIB) libcom_err.la $(DESTDIR)$(LIBDIR)/libcom_err.la
-#	$(CHMOD) 644 $(DESTDIR)$(LIBDIR)/libcom_err.la
-#	$(RANLIB)    $(DESTDIR)$(LIBDIR)/libcom_err.la
-#	$(CHMOD) 444 $(DESTDIR)$(LIBDIR)/libcom_err.la
+#	$(LIBTOOL) --mode=install $(INSTALL) -m 644 libcom_err.la $(DESTDIR)$(LIBDIR)
 ## 
 
 libcom_err.lo:	$(LIBOBJS)
-	ld -r -s -o $@ $? \
-	chmod -x libcom_err.lo
+	$(LIBTOOL) --mode=link --tag=CC ld -r -s -o $@ $?
 
 TAGS:	et_name.c error_message.c compile_et.c error_table.c \
 		lex.yy.c init_et.c
--- cyrus-imapd-2.4.4/configure.in	2010-11-30 07:53:22.188617226 +0200
+++ cyrus-imapd-2.4.4-shared-patch//configure.in	2010-11-30 07:56:42.315002988 +0200
@@ -87,7 +87,7 @@
 AC_DEFINE_UNQUOTED(SYSCONFDIR,"$sysconfdir",[Config File Location])
 
 AC_PROG_CC
-AC_PROG_RANLIB
+AC_PROG_LIBTOOL
 AC_PROG_MAKE_SET
 AC_PROG_INSTALL
 AC_AIX
--- cyrus-imapd-2.4.4/depot/Makefile.in	2010-11-30 07:53:22.195284994 +0200
+++ cyrus-imapd-2.4.4-shared-patch//depot/Makefile.in	2010-11-29 09:03:17.505292828 +0200
@@ -44,11 +44,12 @@
 # $Id$
 
 srcdir = @srcdir@
+top_builddir = @top_builddir@
 VPATH = @srcdir@
 
 CC = @CC@
 INSTALL = @INSTALL@
-RANLIB = @RANLIB@
+LIBTOOL = @LIBTOOL@
 
 DEFS = @DEFS@
 CPPFLAGS = -I. -I$(srcdir) -I$(srcdir)/../lib -I$(srcdir)/../et @CPPFLAGS@ 
@@ -73,11 +74,11 @@
 	$(INSTALL) -m 644 $(srcdir)/rc.local.imap $(DESTDIR)etc
 	$(INSTALL) -m 644 $(srcdir)/rc.local.ptclient $(DESTDIR)etc
 
-.c.lo:
-	$(CC) -c $(CPPFLAGS) $(DEFS) $(CFLAGS) $<
+%.lo: %.c
+	$(LIBTOOL) --mode=compile --tag=CC $(CC) -c $(CPPFLAGS) $(DEFS) $(CFLAGS) $<
 
 clean:
-	rm -f *.lo Makefile.bak makedepend.log
+	rm -rf .libs *.lo *.o Makefile.bak makedepend.log
 
 distclean: clean
 	rm -f Makefile
--- cyrus-imapd-2.4.4/imap/Makefile.in	2010-11-30 07:53:22.195284994 +0200
+++ cyrus-imapd-2.4.4-shared-patch//imap/Makefile.in	2010-11-29 08:33:40.489840319 +0200
@@ -48,12 +48,14 @@
 
 srcdir = @srcdir@
 top_srcdir = @top_srcdir@
+top_builddir = @top_builddir@
 VPATH = @srcdir@
 
 CC = @CC@
 INSTALL = @INSTALL@
 RANLIB = @RANLIB@
 AWK = @AWK@
+LIBTOOL = @LIBTOOL@
 
 CYRUS_USER=@cyrus_user@
 CYRUS_GROUP=@cyrus_group@
@@ -133,22 +135,20 @@
 	$(srcdir)/../install-sh -d ${DESTDIR}$(service_path)
 	for file in $(PROGS); \
 	do \
-		$(INSTALL) -m 755 $$file $(DESTDIR)$(service_path) || exit 1; \
+		$(LIBTOOL) --mode=install $(INSTALL) -m 755 $$file $(DESTDIR)$(service_path) || exit 1; \
 	done
 	ln -f $(DESTDIR)$(service_path)/pop3d $(DESTDIR)$(service_path)/pop3proxyd
 	ln -f $(DESTDIR)$(service_path)/imapd $(DESTDIR)$(service_path)/proxyd
 	ln -f $(DESTDIR)$(service_path)/lmtpd $(DESTDIR)$(service_path)/lmtpproxyd
 
-.c.lo:
-	$(CC) -c $(CPPFLAGS) $(DEFS) $(CFLAGS) \
+%.lo: %.c
+	$(LIBTOOL) --mode=compile --tag=CC $(CC) -c $(CPPFLAGS) $(DEFS) $(CFLAGS) \
 	$<
 
 ### libimap
 
 libimap.la: $(LOBJS)
-	rm -f libimap.la
-	ar cr libimap.la $(LOBJS)
-	$(RANLIB) libimap.la
+	$(LIBTOOL) --mode=link --tag=CC $(CC) -o $@ $(LOBJS)
 
 ### Built Source Files
 
@@ -181,177 +181,177 @@
 
 ### Services
 idled: idled.lo mutex_fake.lo libimap.la $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS)
 
 lmtpd: lmtpd.lo proxy.lo $(LMTPOBJS) $(SIEVE_OBJS) mutex_fake.lo \
 	 libimap.la $(SIEVE_LIBS) $(DEPLIBS) $(SERVICE)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS) $(LIB_WRAP)
 
 lmtpd.pure: lmtpd.lo proxy.lo $(LMTPOBJS) $(SIEVE_OBJS) \
 	 mutex_fake.lo libimap.la $(SIEVE_LIBS) $(DEPLIBS) $(SERVICE)
-	$(PURIFY) $(PUREOPT) $(CC) $(LDFLAGS) -o $@ $? \
+	$(PURIFY) $(PUREOPT) $(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS) $(LIB_WRAP)
 
 imapd: $(IMAPDOBJS) mutex_fake.lo libimap.la $(DEPLIBS) $(SERVICE)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS) $(LIB_WRAP)
 
 imapd.pure: $(IMAPDOBJS) mutex_fake.lo libimap.la $(DEPLIBS) $(SERVICE)
-	$(PURIFY) $(PUREOPT) $(CC) $(LDFLAGS) -o $@ $? \
+	$(PURIFY) $(PUREOPT) $(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS) $(LIB_WRAP)
 
 imapd.quant: $(IMAPDOBJS) mutex_fake.lo libimap.la $(DEPLIBS) $(SERVICE)
-	$(QUANTIFY) $(QUANTOPT) $(CC) $(LDFLAGS) -o $@ $? \
+	$(QUANTIFY) $(QUANTOPT) $(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS) $(LIB_WRAP)
 
 mupdate: mupdate.lo mupdate-slave.lo mupdate-client.lo mutex_pthread.lo tls.lo \
 	libimap.la $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(SERVICETHREAD) \
 	$(LIBS) $(LIB_WRAP) -lpthread
 
 mupdate.pure: mupdate.lo mupdate-slave.lo mupdate-client.lo mutex_pthread.lo \
 	libimap.la $(DEPLIBS)
-	$(PURIFY) $(PUREOPT) $(CC) $(LDFLAGS) -o $@ $? \
+	$(PURIFY) $(PUREOPT) $(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(SERVICETHREAD) \
 	$(LIBS) $(LIB_WRAP) -lpthread
 
 pop3d: pop3d.lo proxy.lo backend.lo tls.lo mutex_fake.lo libimap.la \
 	$(DEPLIBS) $(SERVICE)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS) $(LIB_WRAP)
 
 nntpd: nntpd.lo proxy.lo backend.lo index.lo smtpclient.lo spool.lo tls.lo \
 	 mutex_fake.lo nntp_err.lo libimap.la $(DEPLIBS) $(SERVICE)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS) $(LIB_WRAP)
 
 fud: fud.lo libimap.la mutex_fake.lo $(DEPLIBS) $(SERVICE)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS) $(LIB_WRAP)
 
 smmapd: smmapd.lo libimap.la mutex_fake.lo $(DEPLIBS) $(SERVICE)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS) $(LIB_WRAP)
 
 sync_server: sync_server.lo sync_support.lo \
 	imapparse.lo tls.lo libimap.la mutex_fake.lo $(DEPLIBS) $(SERVICE)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS) $(LIB_WRAP)
 
 ### Command Line Utilities
 arbitron: arbitron.lo $(CLIOBJS) libimap.la $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS)
 
 cyr_userseen: cyr_userseen.lo mutex_fake.lo libimap.la $(CLIOBJS) $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS)
 
 cyr_sequence: cyr_sequence.lo mutex_fake.lo libimap.la $(CLIOBJS) $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS)
 
 cyr_dbtool: cyr_dbtool.lo mutex_fake.lo libimap.la $(CLIOBJS) $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS)
 
 cyr_synclog: cyr_synclog.lo mutex_fake.lo libimap.la $(CLIOBJS) $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS)
 
 cvt_cyrusdb: cvt_cyrusdb.lo mutex_fake.lo libimap.la $(CLIOBJS) $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS)
 
 chk_cyrus: chk_cyrus.lo mutex_fake.lo libimap.la $(CLIOBJS) $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS)
 
 deliver: deliver.lo $(LMTPOBJS) proxy.lo mutex_fake.lo libimap.la $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS)
 
 ctl_deliver: ctl_deliver.lo $(CLIOBJS) libimap.la $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS)
 
 ctl_mboxlist: ctl_mboxlist.lo mupdate-client.lo $(CLIOBJS) libimap.la $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS)
 
 ctl_cyrusdb: ctl_cyrusdb.lo $(CLIOBJS) libimap.la $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS)
 
 cyr_expire: cyr_expire.lo $(CLIOBJS) libimap.la $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS)
 
 fetchnews: fetchnews.lo $(CLIOBJS) libimap.la $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS)
 
 squatter: squatter.lo index.lo squat_build.lo $(CLIOBJS) libimap.la $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS)
 
 mbpath: mbpath.lo $(CLIOBJS) libimap.la $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS)
 
 ipurge: ipurge.lo $(CLIOBJS) libimap.la $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS)
 
 cyr_virusscan: cyr_virusscan.lo index.lo $(CLIOBJS) libimap.la $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS) -lclamav
 
 cyrdump: cyrdump.lo index.lo $(CLIOBJS) libimap.la $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS)
 
 cyr_df: cyr_df.lo $(CLIOBJS) libimap.la $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS)
 
 mbexamine: mbexamine.lo $(CLIOBJS) libimap.la $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS)
 
 reconstruct: reconstruct.lo $(CLIOBJS) libimap.la $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS)
 
 quota: quota.lo $(CLIOBJS) libimap.la $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS)
 
 tls_prune: tls_prune.lo tls.lo $(CLIOBJS) libimap.la $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS)
 
 unexpunge: unexpunge.lo $(CLIOBJS) libimap.la $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS)
 
 sync_client: sync_client.lo sync_support.lo \
 	backend.lo tls.lo imapparse.lo libimap.la mutex_fake.lo $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS)
 
 sync_reset: sync_reset.lo sync_support.lo \
 	libimap.la mutex_fake.lo $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS)
 
 ### Other Misc Targets
 
 clean:
-	rm -f *.lo *.la Makefile.bak makedepend.log \
+	rm -rf .libs *.lo *.o *.la *.a Makefile.bak makedepend.log \
 	$(BUILTSOURCES) $(PROGS) $(SUIDPROGS) cyr_virusscan
 
 distclean: clean
--- cyrus-imapd-2.4.4/imtest/imtest.c	2010-11-30 07:53:22.205286646 +0200
+++ cyrus-imapd-2.4.4-shared-patch//imtest/imtest.c	2010-11-29 08:14:14.318040263 +0200
@@ -283,6 +283,9 @@
     imtest_fatal(msg);
 }
 
+/* config.c stuff */
+const int config_need_data = 0;
+
 int mysasl_config(void *context __attribute__((unused)), 
 		  const char *plugin_name,
 		  const char *option,
--- cyrus-imapd-2.4.4/imtest/Makefile.in	2010-11-30 07:53:22.205286646 +0200
+++ cyrus-imapd-2.4.4-shared-patch//imtest/Makefile.in	2010-11-29 08:56:17.502937602 +0200
@@ -45,11 +45,12 @@
 
 srcdir = @srcdir@
 top_srcdir = @top_srcdir@
+top_builddir = @top_builddir@
 VPATH = @srcdir@
 
 CC = @CC@
 INSTALL = @INSTALL@
-RANLIB = @RANLIB@
+LIBTOOL = @LIBTOOL@
 
 DEFS = @DEFS@ @LOCALDEFS@
 CPPFLAGS = -I.. -I$(srcdir)/../lib @COM_ERR_CPPFLAGS@ @CPPFLAGS@  @SASLFLAGS@
@@ -73,7 +74,7 @@
 all: imtest
 
 install:
-	$(INSTALL) -s -m 755 imtest $(DESTDIR)$(exec_prefix)/bin
+	$(LIBTOOL) --mode=install $(INSTALL) imtest $(DESTDIR)$(exec_prefix)/bin
 	ln -f $(DESTDIR)$(exec_prefix)/bin/imtest $(DESTDIR)$(exec_prefix)/bin/pop3test
 	ln -f $(DESTDIR)$(exec_prefix)/bin/imtest $(DESTDIR)$(exec_prefix)/bin/nntptest
 	ln -f $(DESTDIR)$(exec_prefix)/bin/imtest $(DESTDIR)$(exec_prefix)/bin/lmtptest
@@ -82,19 +83,19 @@
 	ln -f $(DESTDIR)$(exec_prefix)/bin/imtest $(DESTDIR)$(exec_prefix)/bin/sivtest
 	ln -f $(DESTDIR)$(exec_prefix)/bin/imtest $(DESTDIR)$(exec_prefix)/bin/synctest
 
-.c.lo:
-	$(CC) -c $(CPPFLAGS) $(DEFS) $(CFLAGS) $<
+%.lo: %.c
+	$(LIBTOOL) --mode=compile --tag=CC $(CC) -c $(CPPFLAGS) $(DEFS) $(CFLAGS) $<
 
 imtest: imtest.lo $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(IMAP_LIBS)
 
 imtest.pure: imtest.lo $(OBJS) $(DEPLIBS)
-	$(PURIFY) $(PUREOPT) $(CC) $(LDFLAGS) -o $@ $? \
+	$(PURIFY) $(PUREOPT) $(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS) $(IMAP_LIBS)
 
 clean:
-	rm -f *.lo Makefile.bak makedepend.log imtest
+	rm -rf .libs *.lo *.o Makefile.bak makedepend.log imtest
 
 distclean: clean
 	rm -f Makefile
--- cyrus-imapd-2.4.4/installsieve/Makefile.in	2010-11-30 07:53:22.205286646 +0200
+++ cyrus-imapd-2.4.4-shared-patch//installsieve/Makefile.in	2010-11-29 08:23:07.319044464 +0200
@@ -47,6 +47,8 @@
 
 CC = @CC@
 RANLIB = @RANLIB@
+LIBTOOL = @LIBTOOL@
+top_builddir = @top_builddir@
 
 DEFS = @DEFS@
 CPPFLAGS = -I. -I$(srcdir) -I$(srcdir)/../lib @CPPFLAGS@ @SASLFLAGS@
@@ -68,21 +70,19 @@
 all: installsieve
 
 install:
-	$(INSTALL) -s -m 755 installsieve $(DESTDIR)$(exec_prefix)/bin
+	$(LIBTOOL) --mode=install $(INSTALL) installsieve $(DESTDIR)$(exec_prefix)/bin
 
 OBJS=lex.lo mystring.lo request.lo isieve.lo
 
 libinstallsieve.la: $(OBJS)
-	rm -f libinstallsieve.la
-	ar cr libinstallsieve.la $(OBJS)
-	$(RANLIB) libinstallsieve.la
+	$(LIBTOOL) --mode=link --tag=CC $(CC) -o $@ $(OBJS)
 
 installsieve: libinstallsieve.la installscript.lo $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(IMAP_LIBS)
 
 clean:
-	rm -f *.lo *.la Makefile.bak makedepend.log
+	rm -rf .libs *.lo *.o *.la *.a Makefile.bak makedepend.log
 
 distclean: clean
 	rm -f Makefile installsieve
@@ -90,8 +90,8 @@
 depend:
 	${MAKEDEPEND} $(CPPFLAGS) $(DEFS) -I$(srcdir) $(CFLAGS) *.c $(srcdir)/*.c 1>makedepend.log 2>&1
 
-.c.lo:
-	$(CC) -c $(CPPFLAGS) $(DEFS) -I$(srcdir) -I. $(CFLAGS) \
+%.lo: %.c
+	$(LIBTOOL) --mode=compile --tag=CC $(CC) -c $(CPPFLAGS) $(DEFS) -I$(srcdir) -I. $(CFLAGS) \
 	$<
 
 
--- cyrus-imapd-2.4.4/lib/Makefile.in	2010-11-30 07:53:22.205286646 +0200
+++ cyrus-imapd-2.4.4-shared-patch//lib/Makefile.in	2010-11-29 08:53:13.346000595 +0200
@@ -56,7 +56,8 @@
 CC = @CC@
 
 INSTALL = @INSTALL@
-RANLIB = @RANLIB@
+LIBTOOL = @LIBTOOL@
+top_builddir = @top_builddir@
 
 DEFS = @DEFS@ @LOCALDEFS@
 CPPFLAGS = -I.. @CPPFLAGS@ @COM_ERR_CPPFLAGS@ @SASLFLAGS@
@@ -110,9 +111,8 @@
 
 install:
 	$(srcdir)/../install-sh -d $(DESTDIR)$(libdir)
-	$(INSTALL) -m 644 libcyrus.la $(DESTDIR)$(libdir)
-	$(INSTALL) -m 644 libcyrus_min.la $(DESTDIR)$(libdir)
-	 $(RANLIB) $(DESTDIR)$(libdir)/libcyrus.la
+	$(LIBTOOL) --mode=install $(INSTALL) -m 644 libcyrus_min.la $(DESTDIR)$(libdir)
+	$(LIBTOOL) --mode=install $(INSTALL) -m 644 libcyrus.la $(DESTDIR)$(libdir)
 	for file in $(LIBCYR_HDRS); \
 	do \
 		$(INSTALL) -m 644 $$file $(DESTDIR)$(prefix)/include/cyrus || exit 1; \
@@ -122,19 +122,15 @@
 		$(INSTALL) -m 644 $$file $(DESTDIR)$(prefix)/include/cyrus || exit 1; \
 	done
 
-.c.lo:
-	$(CC) -c $(CPPFLAGS) $(DEFS) $(CFLAGS) \
+%.lo: %.c
+	$(LIBTOOL) --mode=compile --tag=CC $(CC) -c $(CPPFLAGS) $(DEFS) $(CFLAGS) \
 	$<
 
-libcyrus.la: $(LIBCYR_OBJS)
-	rm -f libcyrus.la
-	ar cr libcyrus.la $(LIBCYR_OBJS)
-	$(RANLIB) libcyrus.la
+libcyrus.la: $(LIBCYR_OBJS) libcyrus_min.la
+	$(LIBTOOL) --mode=link --tag=CC $(CC) -o $@ $? @LIBS@ @LIB_SASL@ -rpath $(libdir) -release $(VERSION)
 
 libcyrus_min.la: $(LIBCYRM_OBJS)
-	rm -f libcyrus_min.la
-	ar cr libcyrus_min.la $(LIBCYRM_OBJS)
-	$(RANLIB) libcyrus_min.la
+	$(LIBTOOL) --mode=link --tag=CC $(CC) -o $@ $? @IMAP_COM_ERR_LIBS@ -rpath $(libdir) -release $(VERSION)
 
 imapopts.c: imapoptions $(srcdir)/../tools/config2header
 	$(srcdir)/../tools/config2header CC="$(CC)" $(srcdir)/imapopts.c $(srcdir)/imapopts.h < $(srcdir)/imapoptions
@@ -153,7 +149,7 @@
 	@echo "### Done building chartables."
 
 clean:
-	rm -f *.lo *.la chartable.c Makefile.bak makedepend.log \
+	rm -rf .libs *.lo *.o *.la *.a chartable.c Makefile.bak makedepend.log \
 	$(BUILTSOURCES)
 
 distclean: clean
--- cyrus-imapd-2.4.4/makedepend/configure.in	2010-11-30 07:53:22.205286646 +0200
+++ cyrus-imapd-2.4.4-shared-patch//makedepend/configure.in	2010-11-29 08:14:14.308038617 +0200
@@ -2,7 +2,7 @@
 AC_INIT(cppsetup.c)
 AC_PROG_CC
 AC_PROG_INSTALL
-AC_PROG_RANLIB
+AC_PROG_LIBTOOL
 AC_PROG_MAKE_SET
 AC_CHECK_HEADERS(stdarg.h)
 AC_SUBST(CPPFLAGS)
--- cyrus-imapd-2.4.4/makedepend/Makefile.in	2010-11-30 07:53:22.205286646 +0200
+++ cyrus-imapd-2.4.4-shared-patch//makedepend/Makefile.in	2010-11-29 08:54:31.942253188 +0200
@@ -44,11 +44,13 @@
 # $Id$
 # 
 srcdir = @srcdir@
+top_builddir = @top_builddir@
 VPATH = @srcdir@
 
 CC = @CC@
 INSTALL = @INSTALL@
 RANLIB = @RANLIB@
+LIBTOOL = @LIBTOOL@
 
 DEFS = @DEFS@
 CPPFLAGS = -I. -I$(srcdir)  @CPPFLAGS@ 
@@ -62,15 +64,15 @@
 
 all: makedepend
 
-.c.lo:
-	$(CC) -c $(CPPFLAGS) $(DEFS) $(CFLAGS) $<
+%.lo: %.c
+	$(LIBTOOL) --mode=compile --tag=CC $(CC) -c $(CPPFLAGS) $(DEFS) $(CFLAGS) $<
 
 makedepend: cppsetup.lo ifparser.lo include.lo main.lo parse.lo pr.lo $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS)
 
 clean:
-	rm -f *.lo Makefile.bak makedepend
+	rm -rf .libs *.lo *.o Makefile.bak makedepend
 
 distclean: clean
 	rm -f Makefile
--- cyrus-imapd-2.4.4/master/Makefile.in	2010-11-30 07:53:22.205286646 +0200
+++ cyrus-imapd-2.4.4-shared-patch//master/Makefile.in	2010-11-29 08:17:23.282457954 +0200
@@ -48,6 +48,8 @@
 CC = @CC@
 INSTALL = @INSTALL@
 RANLIB = @RANLIB@
+LIBTOOL = @LIBTOOL@
+top_builddir = @top_builddir@
 
 CYRUS_USER=@cyrus_user@
 CYRUS_GROUP=@cyrus_group@
@@ -78,19 +80,19 @@
 	$(srcdir)/../install-sh -d ${DESTDIR}$(service_path)
 	for file in $(PROGS); \
 	do \
-		$(INSTALL) -m 755 $$file $(DESTDIR)$(service_path) || exit 1; \
+		$(LIBTOOL) --mode=install $(INSTALL) $$file $(DESTDIR)$(service_path) || exit 1; \
 	done
 
-.c.lo:
-	$(CC) -c $(CPPFLAGS) $(DEFS) $(CFLAGS) \
+%.lo: %.c
+	$(LIBTOOL) --mode=compile --tag=CC $(CC) -c $(CPPFLAGS) $(DEFS) $(CFLAGS) \
 	$<
 
 master: master.lo masterconf.lo cyrusMasterMIB.lo ../lib/lock_@WITH_LOCK@.lo
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o  $@ $? \
 	$(LIBS) $(DEPLIBS)
 
 clean:
-	rm -f *.lo *.la Makefile.bak $(PROGS)
+	rm -f .libs *.a *.lo *.la Makefile.bak $(PROGS)
 
 distclean: clean
 	rm -f Makefile
--- cyrus-imapd-2.4.4/netnews/Makefile.in	2010-11-30 07:53:22.208620530 +0200
+++ cyrus-imapd-2.4.4-shared-patch//netnews/Makefile.in	2010-11-29 08:37:19.582533564 +0200
@@ -48,7 +48,8 @@
 
 CC = @CC@
 INSTALL = @INSTALL@
-RANLIB = @RANLIB@
+LIBTOOL = @LIBTOOL@
+top_builddir = @top_builddir@
 
 DEFS = @DEFS@
 CPPFLAGS = -I.. -I$(srcdir) -I$(srcdir)/../lib -I$(srcdir)/../com_err/et @CPPFLAGS@
@@ -71,17 +72,17 @@
 all: remotepurge
 
 install:
-	$(INSTALL) -s -m 755 remotepurge $(DESTDIR)$(service_path)
+	$(LIBTOOL) --mode=install $(INSTALL) remotepurge $(DESTDIR)$(service_path)
 
-.c.lo:
-	$(CC) -c $(CPPFLAGS) $(DEFS) $(CFLAGS) $<
+%.lo: %.c
+	$(LIBTOOL) --mode=compile --tag=CC $(CC) -c $(CPPFLAGS) $(DEFS) $(CFLAGS) $<
 
 remotepurge: $(OBJS) $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? $(LIBS)
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? $(LIBS)
 
 
 clean:
-	rm -f *.lo Makefile.bak remotepurge makedepend.log
+	rm -rf .libs *.lo *.o Makefile.bak remotepurge makedepend.log
 
 distclean: clean
 	rm -f Makefile
--- cyrus-imapd-2.4.4/notifyd/Makefile.in	2010-11-30 07:53:22.208620530 +0200
+++ cyrus-imapd-2.4.4-shared-patch//notifyd/Makefile.in	2010-11-29 08:20:28.862982985 +0200
@@ -49,6 +49,8 @@
 
 CC = @CC@
 RANLIB = @RANLIB@
+LIBTOOL = @LIBTOOL@
+top_builddir = @top_builddir@
 
 INSTALL = @INSTALL@
 CYRUS_USER=@cyrus_user@
@@ -82,26 +84,26 @@
 all: notifyd
 
 install:
-	$(INSTALL) -m 755 notifyd $(DESTDIR)$(service_path)
+	$(LIBTOOL) --mode=install $(INSTALL) -m 755 notifyd $(DESTDIR)$(service_path)
 
 OBJS= notifyd.lo notify_null.lo notify_log.lo notify_mailto.lo notify_zephyr.lo \
 	notify_external.lo
 
 notifytest: notifytest.lo
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(DEPLIBS) $(IMAP_LIBS) $(LIBS) $(LIB_WRAP)
 
 notifyd: $(OBJS) $(SERVICE)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(DEPLIBS) $(IMAP_LIBS) $(LIBS) $(LIB_WRAP)
 
 notifyd.pure: $(OBJS) $(SERVICE)
 	$(PURIFY) $(PUREOPT) \
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(DEPLIBS) $(IMAP_LIBS) $(LIBS) $(LIB_WRAP)
 
 clean:
-	rm -f notifyd notifytest *.lo *.la *~ Makefile.bak makedepend.log
+	rm -rf notifyd notifytest .libs *.lo *.o *.la *.a *~ Makefile.bak makedepend.log
 
 distclean: clean
 	rm -f Makefile
@@ -109,8 +111,8 @@
 depend:
 	${MAKEDEPEND} $(CPPFLAGS) $(DEFS) -I$(srcdir) $(CFLAGS) *.c $(srcdir)/*.c 1>makedepend.log 2>&1
 
-.c.lo:
-	$(CC) -c $(CPPFLAGS) $(DEFS) $(CFLAGS) \
+%.lo: %.c
+	$(LIBTOOL) --mode=compile --tag=CC $(CC) -c $(CPPFLAGS) $(DEFS) $(CFLAGS) \
 	$<
 
 # DO NOT DELETE THIS LINE -- make depend depends on it.
--- cyrus-imapd-2.4.4/perl/imap/IMAP.xs	2010-11-30 07:53:22.211954414 +0200
+++ cyrus-imapd-2.4.4-shared-patch//perl/imap/IMAP.xs	2010-11-29 08:14:14.301370855 +0200
@@ -76,6 +76,7 @@
 {
   croak(s);
 }
+const int config_need_data = 0;
 
 /*
  * Decrement the refcounts of the Perl SV's in the passed rock, then free the
--- cyrus-imapd-2.4.4/perl/sieve/lib/Makefile.in	2010-11-30 07:53:22.211954414 +0200
+++ cyrus-imapd-2.4.4-shared-patch//perl/sieve/lib/Makefile.in	2010-11-29 08:44:40.675056075 +0200
@@ -49,7 +49,8 @@
 
 CC = @CC@
 INSTALL = @INSTALL@
-RANLIB = @RANLIB@
+LIBTOOL = @LIBTOOL@
+top_builddir = @top_builddir@
 
 DEFS = @DEFS@ @LOCALDEFS@ -Dbool=char -DHAS_BOOL
 CPPFLAGS = -I. -I../../.. -I$(srcdir) -I$(srcdir)/../../../lib @CPPFLAGS@ @DYNSASLFLAGS@ @COM_ERR_CPPFLAGS@
@@ -74,16 +75,14 @@
 
 install:
 
-.c.lo:
-	$(CC) -c $(CPPFLAGS) $(DEFS) $(CFLAGS) $<
+%.lo: %.c
+	$(LIBTOOL) --mode=compile --tag=CC $(CC) -c $(CPPFLAGS) $(DEFS) $(CFLAGS) $<
 
 libisieve.la: $(OBJS)
-	rm -f libisieve.la
-	ar cr libisieve.la $(OBJS)
-	$(RANLIB) libisieve.la
+	$(LIBTOOL) --mode=link --tag=CC $(CC) -o $@ $(OBJS)
 
 clean:
-	rm -f *.lo Makefile.bak makedepend.log libisieve.la
+	rm -rf .libs *.la *.lo *.o Makefile.bak makedepend.log
 
 distclean: clean
 	rm -f Makefile
--- cyrus-imapd-2.4.4/perl/sieve/managesieve/managesieve.xs	2010-11-30 07:53:22.211954414 +0200
+++ cyrus-imapd-2.4.4-shared-patch//perl/sieve/managesieve/managesieve.xs	2010-11-29 08:14:14.304704736 +0200
@@ -72,6 +72,7 @@
     croak("failure: %s", s);
     exit(-1);
 }
+const int config_need_data = 0;
 
 static int
 perlsieve_getpass(conn, context, id, psecret)
--- cyrus-imapd-2.4.4/ptclient/Makefile.in	2010-11-30 07:53:22.211954414 +0200
+++ cyrus-imapd-2.4.4-shared-patch//ptclient/Makefile.in	2010-11-29 08:58:33.885354117 +0200
@@ -50,7 +50,8 @@
 
 CC = @CC@
 INSTALL = @INSTALL@
-RANLIB = @RANLIB@
+LIBTOOL = @LIBTOOL@
+top_builddir = @top_builddir@
 
 DEFS = @DEFS@
 CPPFLAGS = -I.. -I$(srcdir)/../imap -I$(srcdir)/../lib @COM_ERR_CPPFLAGS@ @CPPFLAGS@ @SASLFLAGS@
@@ -89,36 +90,36 @@
 all: $(PROGS)
 
 install:
-	$(INSTALL) -m 755 ptloader $(DESTDIR)$(service_path)
-	$(INSTALL) -m 755 ptexpire $(DESTDIR)$(service_path)
-	$(INSTALL) -m 755 ptdump $(DESTDIR)$(service_path)
+	$(LIBTOOL) --mode=install $(INSTALL) ptloader $(DESTDIR)$(service_path)
+	$(LIBTOOL) --mode=install $(INSTALL) ptexpire $(DESTDIR)$(service_path)
+	$(LIBTOOL) --mode=install $(INSTALL) ptdump $(DESTDIR)$(service_path)
 
-.c.lo:
-	$(CC) -c $(CPPFLAGS) $(LDAP_CPPFLAGS) $(DEFS) $(CFLAGS) $<
+%.lo: %.c
+	$(LIBTOOL) --mode=compile --tag=CC $(CC) -c $(CPPFLAGS) $(LDAP_CPPFLAGS) $(DEFS) $(CFLAGS) $<
 
 ptloader: ptloader.lo afskrb.lo ldap.lo ../imap/mutex_fake.lo $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? $(SERVICETHREAD) ${AFS_LDFLAGS} ${LDAP_LDFLAGS} $(AFS_LIBS) ${LDAP_LIBS} $(LIB_SASL) $(LIBS) $(LIB_WRAP) $(LIB_RT)
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? $(SERVICETHREAD) ${AFS_LDFLAGS} ${LDAP_LDFLAGS} $(AFS_LIBS) ${LDAP_LIBS} $(LIB_SASL) $(LIBS) $(LIB_WRAP) $(LIB_RT)
 
 ptloader.pure: ptloader.lo afskrb.lo ldap.lo ../imap/mutex_fake.lo $(DEPLIBS)
-	$(PURIFY) $(PUREARGS) $(CC) $(LDFLAGS) -o $@ $? $(SERVICETHREAD) ${AFS_LDFLAGS} ${LDAP_LDFLAGS} $(AFS_LIBS) ${LDAP_LIBS} $(LIB_SASL) $(LIBS) $(LIB_WRAP) $(LIB_RT)
+	$(PURIFY) $(PUREARGS) $(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? $(SERVICETHREAD) ${AFS_LDFLAGS} ${LDAP_LDFLAGS} $(AFS_LIBS) ${LDAP_LIBS} $(LIB_SASL) $(LIBS) $(LIB_WRAP) $(LIB_RT)
 
 ptexpire: ptexpire.lo $(DEPLIBS) $(UTIL_LIBS)
-	$(CC) $(LDFLAGS) -o $@ $? $(LIB_SASL) $(LIBS) $(LIB_RT)
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? $(LIB_SASL) $(LIBS) $(LIB_RT)
 
 ptexpire.pure: ptexpire.lo $(DEPLIBS) $(UTIL_LIBS)
-	$(PURIFY) $(PUREARGS) $(CC) $(LDFLAGS) -o $@ $? $(LIB_SASL) $(LIBS) $(LIB_WRAP) $(LIB_RT)
+	$(PURIFY) $(PUREARGS) $(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? $(LIB_SASL) $(LIBS) $(LIB_WRAP) $(LIB_RT)
 
 ptdump: ptdump.lo $(DEPLIBS) $(UTIL_LIBS)
-	$(CC) $(LDFLAGS) -o $@ $? $(LIB_SASL) $(LIBS) $(LIB_RT)
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? $(LIB_SASL) $(LIBS) $(LIB_RT)
 
 ptdump.pure: ptdump.lo $(DEPLIBS) $(UTIL_LIBS)
-	$(PURIFY) $(PUREARGS) $(CC) $(LDFLAGS) -o $@ $? $(LIB_SASL) $(LIBS) $(LIB_WRAP) $(LIB_RT)
+	$(PURIFY) $(PUREARGS) $(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? $(LIB_SASL) $(LIBS) $(LIB_WRAP) $(LIB_RT)
 
 ptextract: ptextract.lo $(DEPLIBS) $(UTIL_LIBS)
-	$(CC) $(LDFLAGS) -o $@ $? $(LIBS)
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? $(LIBS)
 
 clean:
-	rm -f *.lo Makefile.bak $(PROGS) makedepend.log
+	rm -rf .libs *.lo *.o Makefile.bak $(PROGS) makedepend.log
 
 distclean: clean
 	rm -f Makefile
--- cyrus-imapd-2.4.4-shared-patch//sieve/Makefile.in	2010-11-29 09:06:25.952918572 +0200
+++ cyrus-imapd-2.4.18/sieve/Makefile.in	2016-07-28 13:36:20.937139019 +0300
@@ -44,6 +44,7 @@
 
 srcdir = @srcdir@
 top_srcdir = @top_srcdir@
+top_builddir = @top_builddir@
 VPATH = @srcdir@
 
 prefix = @prefix@
@@ -51,10 +52,11 @@
 service_path = @service_path@
 
 CC = @CC@
+INSTALL = @INSTALL@
 YACC = @YACC@
 YFLAGS = -d
 LEX = @LEX@
-RANLIB = @RANLIB@
+LIBTOOL = @LIBTOOL@
 COMPILE_ET = @COMPILE_ET@
 
 DEFS = @DEFS@ @LOCALDEFS@
@@ -81,11 +83,11 @@
 
 install: sievec sieved
 	$(srcdir)/../install-sh -d ${DESTDIR}$(service_path)
-	$(srcdir)/../install-sh -c -m 755 sievec $(DESTDIR)$(service_path) || exit
-	$(srcdir)/../install-sh -c -m 755 sieved $(DESTDIR)$(service_path) || exit
+	$(LIBTOOL) --mode=install $(INSTALL) -m 755 sievec $(DESTDIR)$(service_path)
+	$(LIBTOOL) --mode=install $(INSTALL) -m 755 sieved $(DESTDIR)$(service_path)
 
 test: libsieve.la test.lo ../imap/message.lo $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? \
 	$(LIBS)
 
 OBJS = sieve_err.lo \
@@ -119,15 +121,13 @@
 #libsieve.la: sieve.c sieve.h sieve_err.h sieve_err.c $(OBJS)
 #changed to...
 libsieve.la: $(OBJS)
-	rm -f libsieve.la
-	ar cr libsieve.la $(OBJS)
-	$(RANLIB) libsieve.la
+	$(LIBTOOL) --mode=link --tag=CC $(CC) -o $@ $(OBJS)
 
 sievec: sievec.lo libsieve.la $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? $(LIBS)
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? $(LIBS)
 
 sieved: sieved.lo libsieve.la $(DEPLIBS)
-	$(CC) $(LDFLAGS) -o $@ $? $(LIBS)
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ sieved.lo libsieve.la $(LIBS) $(DEPLIBS)
 
 
 sieve_interface.h: sieve_err.h
@@ -136,7 +136,7 @@
 	$(COMPILE_ET) $(srcdir)/sieve_err.et
 
 clean:
-	rm -f sievec sieved test *~ *.lo *.la Makefile.bak makedepend.log
+	rm -rf .libs sievec sieved test *~ *.lo *.o *.la *.a Makefile.bak makedepend.log
 
 distclean: clean
 	rm -f sieve_err.c sieve_err.h
@@ -148,7 +148,8 @@
 depend:
 	${MAKEDEPEND} $(CPPFLAGS) $(DEFS) -I$(srcdir) $(MAKEDEPEND_CFLAGS) *.c *.y $(srcdir)/*.y $(srcdir)/*.c 1>makedepend.log 2>&1
 
-.c.lo:
+%.lo: %.c
+	$(LIBTOOL) --mode=compile --tag=CC \
 	$(CC) -c $(CPPFLAGS) $(DEFS) $(CFLAGS) \
 	$<
 
--- cyrus-imapd-2.4.4/syslog/Makefile.in	2010-11-30 07:53:22.215288298 +0200
+++ cyrus-imapd-2.4.4-shared-patch//syslog/Makefile.in	2010-11-29 08:25:14.816679541 +0200
@@ -44,12 +44,14 @@
 # $Id$
 
 srcdir = @srcdir@
+top_builddir = @top_builddir@
 VPATH = @srcdir@
 
 CC = @CC@
 
 INSTALL = @INSTALL@
 RANLIB = @RANLIB@
+LIBTOOL = @LIBTOOL@
 
 DEFS = @DEFS@
 CPPFLAGS = @CPPFLAGS@
@@ -66,18 +68,17 @@
 install:
 	@echo "Install syslogd and syslog.conf as appropriate"
 
-.c.lo:
-	$(CC) -c $(CPPFLAGS) $(DEFS) -I$(srcdir) $(CFLAGS) $<
+%.lo: %.c
+	$(LIBTOOL) --mode=compile --tag=CC $(CC) -c $(CPPFLAGS) $(DEFS) -I$(srcdir) $(CFLAGS) $<
 
 libsyslog.la: syslog.lo
-	ar cr libsyslog.la syslog.lo
-	$(RANLIB) libsyslog.la
+	$(LIBTOOL) --mode=link --tag=CC $(CC) -o $@ $<
 
 syslogd: syslogd.lo
-	$(CC) $(LDFLAGS) -o $@ $? $(LIBS)
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ $? $(LIBS)
 
 clean:
-	rm -f *.lo *.la Makefile.bak
+	rm -rf .libs *.lo *.o *.la *.a Makefile.bak
 
 distclean: clean
 	rm -f Makefile
--- cyrus-imapd-2.4.4/timsieved/Makefile.in	2010-11-30 07:53:22.215288298 +0200
+++ cyrus-imapd-2.4.4-shared-patch//timsieved/Makefile.in	2010-11-29 08:40:02.882717314 +0200
@@ -48,7 +48,8 @@
 VPATH = @srcdir@
 
 CC = @CC@
-RANLIB = @RANLIB@
+LIBTOOL = @LIBTOOL@
+top_builddir = @top_builddir@
 
 INSTALL = @INSTALL@
 CYRUS_USER=@cyrus_user@
@@ -82,22 +83,22 @@
 all: timsieved
 
 install:
-	$(INSTALL) -m 755 timsieved $(DESTDIR)$(service_path)
+	$(LIBTOOL) --mode=install $(INSTALL) -m 755 timsieved $(DESTDIR)$(service_path)
 
 OBJS= actions.lo lex.lo mystring.lo scripttest.lo timsieved.lo parser.lo \
 	../imap/proxy.lo
 
 timsieved: $(OBJS) $(SERVICE)
-	$(CC) $(LDFLAGS) -o $@ \
+	 $(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ \
 	 $(SERVICE) $(OBJS) $(DEPLIBS) $(IMAP_LIBS) $(LIBS) $(LIB_WRAP)
 
 timsieved.pure: $(OBJS) $(SERVICE)
 	$(PURIFY) $(PUREOPT) \
-	$(CC) $(LDFLAGS) -o $@ \
+	$(LIBTOOL) --mode=link --tag=CC $(CC) $(LDFLAGS) -o $@ \
 	 $(SERVICE) $(OBJS) $(DEPLIBS) $(IMAP_LIBS) $(LIBS) $(LIB_WRAP)
 
 clean:
-	rm -f timsieved *~ *.lo *.la Makefile.bak makedepend.log
+	rm -rf timsieved .libs *~ *.lo *.o *.la *.a Makefile.bak makedepend.log
 
 distclean: clean
 	rm -f Makefile
@@ -105,8 +106,8 @@
 depend:
 	${MAKEDEPEND} $(CPPFLAGS) $(DEFS) -I$(srcdir) $(CFLAGS) *.c $(srcdir)/*.c 1>makedepend.log 2>&1
 
-.c.lo:
-	$(CC) -c $(CPPFLAGS) $(DEFS) $(CFLAGS) \
+%.lo: %.c
+	$(LIBTOOL) --mode=compile --tag=CC $(CC) -c $(CPPFLAGS) $(DEFS) $(CFLAGS) \
 	$<
 
 # DO NOT DELETE THIS LINE -- make depend depends on it.
--- cyrus-imapd-2.4.10/perl/sieve/managesieve/Makefile.PL.wiget	2011-07-04 17:05:01.000000000 +0200
+++ cyrus-imapd-2.4.10/perl/sieve/managesieve/Makefile.PL	2011-07-31 19:33:33.426399853 +0200
@@ -61,8 +61,8 @@ WriteMakefile(
     'NAME'	=> 'Cyrus::SIEVE::managesieve',
     'ABSTRACT'  => 'Cyurs Sieve management interface',
     'VERSION_FROM' => 'managesieve.pm', # finds $VERSION
-    'MYEXTLIB'  => '../lib/isieve.o ../lib/lex.o ../lib/mystring.o ../lib/request.o ../../../lib/libcyrus.a ../../../lib/libcyrus_min.a',
-    'LIBS'	=> ["$BDB_LIB $SASL_LIB $OPENSSL_LIB $LIB_RT $ZLIB -lssl -lcrypto"], 
+    'MYEXTLIB'  => '../lib/isieve.o ../lib/lex.o ../lib/mystring.o ../lib/request.o',
+    'LIBS'	=> ["$BDB_LIB $SASL_LIB $OPENSSL_LIB $LIB_RT $ZLIB -lssl -lcrypto -L../../../lib/.libs -lcyrus -lcyrus_min"], 
     'DEFINE'	=> '-DPERL_POLLUTE',     # e.g., '-DHAVE_SOMETHING' 
     'INC'	=> "-I../lib/ -I../../../lib/ $SASL_INC $OPENSSL_INC",
 );
--- cyrus-imapd-2.4.10/perl/imap/Makefile.PL.wiget	2011-07-04 17:05:01.000000000 +0200
+++ cyrus-imapd-2.4.10/perl/imap/Makefile.PL	2011-07-31 20:20:12.772972475 +0200
@@ -73,8 +73,8 @@ WriteMakefile(
     'macro'	=> {'IMCLIENT_LIBS' => ''},	# hack
     'clean'	=> {'FILES' => 'libcyrperl.a cyradm'},
     'OBJECT'    => 'IMAP.o',
-    'MYEXTLIB'  => '../../lib/libcyrus.a ../../lib/libcyrus_min.a',
-    'LIBS'	=> ["$BDB_LIB $SASL_LIB $OPENSSL_LIB $LIB_RT $ZLIB -lssl -lcrypto"],
+    'MYEXTLIB'  => '',
+    'LIBS'	=> ["$BDB_LIB $SASL_LIB $OPENSSL_LIB $LIB_RT $ZLIB -lssl -lcrypto -L../../lib/.libs -lcyrus -lcyrus_min"],
     'DEFINE'	=> '-DPERL_POLLUTE',    # e.g., '-DHAVE_SOMETHING' 
     'INC'	=> "-I../../lib -I../.. -I../../com_err/et $SASL_INC $OPENSSL_INC", 
     'EXE_FILES' => [cyradm],
